using System.Text;

namespace EFCore.DomainModelGenerator.CodeGeneration;

internal class DomainRegistratorGeneration(string ns, DomainMetadata[] domains)
{
  private string Namespace { get; } = ns;
  private IEnumerable<string> DomainClassNames { get; } = domains.Select(x => x.DomainName);

  public string GenerateCode()
  {
    var registrationCode = GenerateRegistrationCode();
    return
      $$"""
        // <auto-generated/>

        namespace {{Namespace}};

        public static class DomainRegistrationHelper
        {
          public static global::Microsoft.Extensions.DependencyInjection.IServiceCollection AddDomains(this global::Microsoft.Extensions.DependencyInjection.IServiceCollection services)
          {
          {{registrationCode}}
          return services;
          }
        }
        """;
  }

  private string GenerateRegistrationCode()
  {
    var codes = DomainClassNames.Select(GenerateSingleRegistrationCode);
    var sb = new StringBuilder();
    foreach (var code in codes)
    {
      sb.AppendLine(code);
    }

    return sb.ToString();
  }

  private static string GenerateSingleRegistrationCode(string domainClassName)
  {
    return $"services.AddScoped<{domainClassName}>();";
  }
}
